# 12. Ο προεπεξεργαστής της C

<i>Σύνοψη</i> Ο ρόλος του προεπεξεργαστή της C, οδηγίες προεπεξεργαστή, μακροεντολές, μακροεντολές με μεταβλητό πλήθος ορισμάτων, stringification, προκαθορισμένες μακροεντολές (<span class="p-style">\_\_DATE\_\_, \_\_ΤΙΜΕ\_\_</span> κ.ά.), οδηγίες υπό συνθήκη, φρουροί include,  
το <span class="p-style">#if 0</span>, οι οδηγίες <span class="p-style">#error, #pragma, #line</span>.  

<i>Προαπαιτούμενη γνώση</i> Τύποι δεδομένων, συναρτήσεις, πίνακες, δομές, δείκτες, είσοδος/έξοδος.

## 12.1 Ο προεπεξεργαστής της C

Η C σε αντίθεση με τις περισσότερες γλώσσες προγραμματισμού διαθέτει προεπεξεργαστή (preprocessor). Ο προεπεξεργαστής της C είναι ένα πρόγραμμα που εκτελείται πριν τη μεταγλώττιση και αναλαμβάνει να επεξεργαστεί ειδικές εντολές που έχουν τη μορφή οδηγιών (directives) και που ξεκινούν με τον χαρακτήρα # στον πηγαίο κώδικα. Ο προεπεξεργαστής μετασχηματίζει τον πηγαίο κώδικα σε μια νέα μορφή κάνοντας αντικαταστάσεις τμημάτων του πηγαίου κώδικα. Αυτή η νέα μορφή κώδικα στη συνέχεια δίνεται στον μεταγλωττιστή που το μετατρέπει σε γλώσσα μηχανής, ακολουθώντας μια σειρά βημάτων.  
Οι οδηγίες του προεπεξεργαστή της C ξεκινούν με το σύμβολο <span class="p-style">#</span> που είναι γνωστό ως δίεση ή pound ή hash ή octothorpe. Οι κύριες οδηγίες είναι το <span class="p-style">#include</span> και το <span class="p-style">#define</span>, ενώ συχνά χρησιμοποιούνται και οι οδηγίες υπό συνθήκη <span class="p-style">#if</span>, <span class="p-style">#else</span>, <span class="p-style">#elif</span> και <span class="p-style">#endif</span>. Μια αναλυτική περι γραφή των δυνατοτήτων του προεπεξεργαστή της C για τον GCC υπάρχει στο “The C Preprocessor” από τους Richard M. Stallman και Zachary Weinberg [^1].  
Υπάρχουν και άλλες γλώσσες προγραμματισμού που διαθέτουν προεπεξεργαστή όπως η C++, η PL/I και η PHP, ενώ ορισμένες γλώσσες προγραμματισμού όπως η JavaScript χρησιμοποιούν προεπεξεργαστές για να προσθέσουν επιπλέον χαρακτηριστικά στη γλώσσα (π.χ. TypeScript). Στα συστήματα Linux/UNIX υπάρχει η γλώσσα προγραμματισμού M4 που ανήκει στο πρότυπο POSIX και αποτελεί έναν επεξεργαστή μακροεντολών γενικού σκοπού που επιτρέπει την απλοποίηση επαναλαμβανόμενων εργασιών. Η M4 χρησιμοποιείται εκτεταμένα στο build σύστημα GNU Autotools και βοηθά στον εντοπισμό των κατάλληλων ρυθμίσεων που επιτρέπουν την ορθή παραγωγή κώδικα σε συστήματα Linux/UNIX.


## 12.2 Η οδηγία include

Η οδηγία <span class="p-style">#include</span> επιτρέπει τη συμπερίληψη των περιεχομένων ενός αρχείου κώδικα σε ένα άλλο αρχείο κώδικα στο οποίο έχει τοποθετηθεί η οδηγία <span class="p-style">include</span>. Είναι συνηθισμένο να γίνονται <span class="p-style">include</span> αρχεία επικεφαλίδων συστήματος όπως για παράδειγμα συμβαίνει με την οδηγία <span class="p-style">#include <stdio.h></span>, οπότε και δίνεται η δυνατότητα χρήσης συναρτήσεων που δηλώνονται στο αρχείο επικεφαλίδας <span class="p-style">stdio.h</span> όπως η συνάρτηση <span class="p-style">printf()</span>. Κάθε οδηγία <span class="p-style">include</span> ακολουθείται από ένα όνομα αρχείου και είτε χρησιμοποιούνται τα σύμβολα <span class="p-style"><</span> και <span class="p-style">></span> για να το περικλείουν είτε τα διπλά εισαγωγικά <span class="p-style">"</span>. Στην πρώτη περίπτωση το αρχείο αναζητείται σε καταλόγους που η εγκατάσταση της C έχει ορίσει ως καταλόγους συστήματος. Στη λίστα των καταλόγων συστήματος μπορούν να προστεθούν επιπλέον κατάλογοι με την επιλογή <span class="p-style">‐I</span> κατά τη μεταγλώττιση του πηγαίου κώδικα. Στην περίπτωση που το όνομα του αρχείου που πρόκειται να συμπεριληφθεί βρίσκεται μέσα σε διπλά εισαγωγικά τότε το αρχείο αναζητείται στον τρέχοντα κατάλογο. Στο παράδειγμα που ακολουθεί το αρχείο <span class="p-style">ch12_p1.h</span> (κώδικας 12.1) περιέχει τη δήλωση της συνάρτησης <span class="p-style">foo()</span>. To αρχείο αυτό γίνεται <span class="p-style">include</span> στο αρχείο <span class="p-style">ch12_p1.c</span> (κώδικας 12.2), οπότε τα περιεχόμενά του συμπεριλαμβάνονται στη θέση στην οποία υπάρχει η εντολή <span class="p-style">#include "ch12_p1.h"</span>.


```{.c title="Κώδικας 12.1: ch12_p1.h - αρχείο επικεφαλίδας που περιέχει τη δήλωση της συνάρτηση foo()." linenums="1"}
--8<-- "src/ch12_p1.h"
```

```{.c title="Κώδικας 12.2: ch12_p1.c - ο πηγαίος κώδικας που ορίζει τη συνάρτηση foo() και περιέχει τη main()." linenums="1"}
--8<-- "src/ch12_p1.c"
```

Η μεταγλώττιση και εκτέλεση δίνουν το ακόλουθο αποτέλεσμα:

```
$ gcc ch12_p1.c ‐o ch12_p1
$ ./ch12_p1
foo function called with argument 42
```
Αν στην οδηγία <span class="p-style">include</span> έχουν συμπεριληφθεί και πληροφορίες υποκαταλόγων, όπως για παράδειγμα στο <span class="p-style">#include "myheaders/myheader.h"</span> τότε το αρχείο <span class="p-style">myheader.h</span> θα αναζητηθεί στον υποκατάλογο <span class="p-style">myheaders</span> κάτω από τον τρέχοντα κατάλογο προκειμένου τα περιεχόμενά του να συμπεριληφθούν στο σημείο που γίνεται το <span class="p-style">include</span>.

## 12.3 Η οδηγία define και η οδηγία undef

Η οδηγία <span class="p-style">define</span> επιτρέπει τον ορισμό μακροεντολών που αντικαθιστούν λεκτικά σύμβολα με τμήματα κειμένου στον πηγαίο κώδικα. Η αντικατάσταση γίνεται χωρίς να ελέγχεται η ορθότητα του κώδικα που προκύπτει, οπότε αν ο κώδικας που προκύπτει δεν είναι ορθός συντακτικά, αυτό ελέγχεται από τον μεταγλωττιστή στη συνέχεια. Η γενική μορφή μιας οδηγίας <span class="p-style">define</span> είναι η ακόλουθη.

```
#define λεκτικό_σύμβολο κείμενο_αντικατάστασης
```

Αν το κείμενο αντικατάστασης καταλαμβάνει περισσότερες από μία γραμμές τότε τοποθετείται το σύμβολο backslash <span class="p-style">\</span> στο τέλος κάθε γραμμής που συνεχίζεται σε επόμενη γραμμή. Οι μακροεντολές χωρίζονται στις μακροεντολές τύπου αντικειμένου και στις μακροεντολές τύπου συνάρτησης. Οι πρώτες αντικαθιστούν απλά το λεκτικό σύμβολο με το κείμενο αντικατάστασης σε όλες τις εμφανίσεις του συμβόλου. Εξαιρούνται εμφανίσεις του συμβόλου μέσα σε διπλά εισαγωγικά, καθώς και εμφανίσεις του συμβόλου ως υποσυμβολοσειρά σε άλλο λεκτικό σύμβολο. Συνεπώς, στον κώδικα 12.3 που ακολουθεί γίνονται μόνο δύο αντικαταστάσεις του λεκτικού συμβόλου <span class="p-style">FOO</span>, παρά το ότι η ακολουθία χαρακτήρων <span class="p-style">FOO</span> υπάρχει τέσσερις φορές στον κώδικα.

```{.c title="Κώδικας 12.3: ch12_p2.c - δύο αντικαταστάσεις του λεκτικού συμβόλου FOO από τον προεπεξεργαστή." linenums="1"}
--8<-- "src/ch12_p2.c"
```

Χρησιμοποιώντας τον διακόπτη <span class="p-style">‐E</span> ο μεταγλωττιστής gcc (και ο clang) επιστρέφει τον πηγαίο κώδικα μετά την εφαρμογή των αντικαταστάσεων που προκαλεί ο προεπεξεργαστής.

```
$ gcc ‐E ch12_p2.c
int main(){
    int foo = 1729;
    int FOOBAR = 1729;
    char* bar = "FOO and BAR are placeholder names in computer programming";
}
```

Οι μακροεντολές τύπου συνάρτησης δέχονται ορίσματα με συνέπεια το κείμενο αντικατάστασης να αλλάζει ανάλογα με την κάθε εφαρμογή της μακροεντολής στα διάφορα σημεία του κώδικα. Στο παράδειγμα που ακολουθεί στον κώδικα 12.4 ορίζεται μια μακροεντολή με όνομα <span class="p-style">SQUARE</span> που μπορεί να χρησιμοποιηθεί για τον υπολογισμό του τετραγώνου της παραμέτρου της. Παρατηρήστε τις επιπλέον παρενθέσεις γύρω από κάθε εμφάνιση της παραμέτρου <span class="p-style">x</span>, καθώς και τις παρενθέσεις στο σύνολο του κειμένου αντικατάστασης. Η χρήση αυτών των παρενθέσεων είναι καλή πρακτική έτσι ώστε η σειρά των πράξεων να είναι η αναμενόμενη. Για παράδειγμα αν δεν υπήρχαν οι παρενθέσεις γύρω από κάθε εμφάνιση του <span class="p-style">x</span>, τότε η αντικατάσταση της μακροεντολής στο <span class="p-style">SQUARE(1+2)</span> θα έδινε το <span class="p-style">1+2*1+2</span> που υπολογίζεται σε 5 και όχι στο τετράγωνο του 3, δηλαδή το 9, που είναι η ορθή τιμή αποτελέσματος.


```{.c title="Κώδικας 12.4: ch12_p3.c - παράδειγμα μακροεντολής που δέχεται όρισμα." linenums="1"}
--8<-- "src/ch12_p3.c"
```

```
$ gcc ch12_p3.c ‐o ch12_p3
$ ./ch12_p3
49
64
```

Μια ιδιαιτερότητα της χρήσης μακροεντολών τύπου συναρτήσεων είναι ότι σε περιπτώσεις που ένα όρισμα είναι έκφραση και εντοπίζεται στο κείμενο αντικατάστασης περισσότερες από μία φορές, η έκφραση θα αποτιμηθεί και αυτή περισσότερες από μία φορές. Έτσι στο παράδειγμα με την μακροεντολή <span class="p-style">SQUARE</span>, αν το όρισμα είναι <span class="p-style">a+1</span>, τότε η αποτίμηση του αποτελέσματος γίνεται δύο φορές. Αυτό μπορεί σε κάποιες περιπτώσεις να εισάγει περιττούς υπολογισμούς, αλλά συνήθως είναι ένα θέμα που οι μεταγλωττιστές μπορούν να χειριστούν έτσι ώστε να μην παρατηρείται υποβάθμιση της απόδοσης του προγράμματος. Σημαντικότερο είναι το πρόβλημα που δημιουργείται όταν η έκφραση προκαλεί παρενέργειες (side-effects), όπως για παράδειγμα στην περίπτωση του <span class="p-style">SQUARE(a++)</span>. Λόγω του ότι η παράμετρος <span class="p-style">x</span> χρησιμοποιείται 2 φορές στο κείμενο αντικατάστασης θα προκύψει το κείμενο αντικατάστασης <span class="p-style">(a++) * (a++)</span> και συνεπώς η τιμή του ορίσματος <span class="p-style">a</span> θα αυξηθεί 2 φορές κατά ένα, κάτι το οποίο δεν είναι προφανές σε κάποιον που δεν γνωρίζει την υλοποίηση της μακροεντολής. Για να αποφευχθεί αυτή η συμπεριφορά μπορεί η μακροεντολή να γραφεί μέσα σε ένα μπλοκ κώδικα όπως συμβαίνει στον κώδικα 12.5.

```{.c title="Κώδικας 12.5: ch12_p3b.c - αποφυγή πολλαπλής αποτίμησης ορίσματος σε μακροεντολή." linenums="1"}
--8<-- "src/ch12_p3b.c"
```

Η εμβέλεια ενός ονόματος λεκτικού συμβόλου που ορίζεται με την <span class="p-style">define</span> είναι από το σημείο ορισμού της μέχρι το τέλος του αρχείου στο οποίο ορίζεται. Ωστόσο, η χρήση της οδηγίας <span class="p-style">undef</span> ακολουθούμενης από το όνομα του λεκτικού συμβόλου ακυρώνει νωρίτερα τον ορισμό του ονόματος.  
Αξίζει να αναφερθεί ότι η οδηγία <span class="p-style">define</span> μπορεί μόνο να ορίζει ένα όνομα λεκτικού συμβόλου χωρίς να διαθέτει κείμενο αντικατάστασης. Μια εφαρμογή αυτής της δυνατότητας παρουσιάζεται στην παράγραφο 12.5.

### 12.3.1 Ο ρόλος των συμβόλων \# και \#\# στο κείμενο αντικατάστασης των οδηγιών define

Τα ορίσματα μιας μακροεντολής μπορούν να μετατραπούν σε συμβολοσειρές τοποθετώντας το σύμβολο <span class="p-style">#</span> πριν το όνομά τους στο κείμενο αντικατάστασης. Η μετατροπή ορισμάτων στα λεκτικά των ονομάτων τους, στις μακροεντολές, ονομάζεται stringification. Ένα σχετικό παράδειγμα παρουσιάζεται στον κώδικα 12.6.

```{.c title="Κώδικας 12.6: ch12_p4.c - παράδειγμα μακροεντολής που εκτελεί stringification." linenums="1"}
--8<-- "src/ch12_p4.c"
```

Η μεταγλώττιση του κώδικα και η εκτέλεσή του δίνουν τα ακόλουθα αποτελέσματα:

```
$ gcc ch12_p4.c ‐o ch12_p4
$ ./ch12_p4
a = 42
a+1 = 43
```

Παρατηρήστε ότι στον κώδικα 12.6, στη δήλωση της μακροεντολής, χρησιμοποιείται το τέχνασμα συνένωσης δύο συμβολοσειρών που βρίσκονται η μια δίπλα στην άλλη (του <span class="p-style">#x</span> και του <span class="p-style">" = %d\n"</span>). Ισχύει δηλαδή ότι για τη C, το <span class="p-style">"HELLO" "WORLD"</span> είναι ισοδύναμο με το <span class="p-style">"HELLOWORLD"</span>.  
Ειδικό ρόλο έχουν και τα δύο συνεχόμενα σύμβολα δίεσης <span class="p-style">##</span> καθώς μπορούν να χρησιμοποιηθούν για το λεγόμενο pasting ή concatenation. Όταν αντικαθίσταται μια μακροεντολή που έχει στο κείμενο αντικατάστασής της το <span class="p-style">##</span> τότε τα δύο σύμβολα που βρίσκονται αριστερά και δεξιά από τα <span class="p-style">##</span> συνδυάζονται σε ένα σύμβολο. Στο παράδειγμα του κώδικα 12.7 ορίζεται η μακροεντολή <span class="p-style">CAT</span> που συνενώνει τα δύο ορίσματά της και χρησιμοποιείται τόσο για τον ορισμό ονομάτων μεταβλητών όσο και για τη δημιουργία αριθμητικών τιμών με επιστημονικό συμβολισμό (1) (π.χ. 2e6).  
{ .annotate }

1. <a href="https://science.howstuffworks.com/math-concepts/scientific-notation.htm" target="_blank">https://science.howstuffworks.com/math-concepts/scientific-notation.htm</a>

```{.c title="Κώδικας 12.7: ch12_p5.c - παράδειγμα μακροεντολής που συνενώνει τα ορίσματά της." linenums="1"}
--8<-- "src/ch12_p5.c"
```

Η εκτέλεση του κώδικα θα δώσει τα ακόλουθα αποτελέσματα:

```
$ gcc ch12_p5.c ‐o ch12_p5
$ ./ch12_p5
1000000
2000000.000000
```

Μια πρακτική χρήση του <span class="p-style">##</span> παρουσιάζεται στον κώδικα 12.8 όπου η μακροεντολή <span class="p-style">DECLARE_WITH_COPY</span> δηλώνει και ορίζει μια μεταβλητή και ταυτόχρονα δηλώνει και ορίζει ένα αντίγραφό της με το ίδιο όνομα αλλά με την προσθήκη του <span class="p-style">_copy</span> στο τέλος του ονόματός της.

```{.c title="Κώδικας 12.8: ch12_p5b.c παράδειγμα μακροεντολής που δηλώνει και ορίζει μια μεταβλητή καθώς και ένα αντίγραφό της." linenums="1"}
--8<-- "src/ch12_p5b.c"
```

Η εκτέλεση του κώδικα εμφανίζει τα ακόλουθα αποτελέσματα:

```
$ gcc ch12_p5b.c ‐o ch12_p5b
$ ./ch12_p5b
SPEED = 72.00
SPEED (original) = 60.00
```

### 12.3.2 Μακροεντολές με μεταβλητό πλήθος ορισμάτων

Υπάρχει η δυνατότητα ορισμού μακροεντολής που θα χρησιμοποιεί μεταβλητό πλήθος ορισμάτων. Αυτό γίνεται με τη χρήση των 3 τελειών ως τελευταίο όρισμα της μακροεντολής και του συμβόλου <span class="p-style">\_\_VA_ARGS__</span> στο κείμενο αντικατάστασης. Ο κώδικας 12.9 αποτελεί ένα παράδειγμα χρήσης μεταβλητού πλήθους ορισμάτων σε μακροεντολή.

```{.c title="Κώδικας 12.9: ch12_p6.c - μακροεντολή που δέχεται μεταβλητό πλήθος ορισμάτων." linenums="1"}
--8<-- "src/ch12_p6.c"
```

Η εκτέλεση του κώδικα θα δώσει τα ακόλουθα αποτελέσματα:

```
$ gcc ch12_p6.c ‐o ch12_p6
$ ./ch12_p6
arg0=42, arg1=foo
arg0=42, arg1=foo, arg2=3.141592
```

## 12.4 Προκαθορισμένες μακροεντολές

Το πρότυπο της C ορίζει ένα σύνολο από προκαθορισμένες (built-in) μακροεντολές που μπορούν να χρησιμοποιηθούν απευθείας. Ορισμένες από αυτές είναι οι ακόλουθες. 

- <span class="p-style">\_\_DATE__</span>, τρέχουσα ημερομηνία σε μορφή μήνας, ημέρα μήνα με 2 ψηφία, έτος με τέσσερα ψηφία (<span class="p-style">M dd yyyy</span>).
- <span class="p-style">\_\_TIME__</span>, τρέχουσα ώρα.
- <span class="p-style">\_\_FILE__</span>, όνομα αρχείου στο οποίο βρίσκεται η μακρονεντολή.
- <span class="p-style">\_\_LINE__</span>, αριθμός γραμμής που βρίσκεται η μακροεντολή.
- <span class="p-style">\_\_STDC__</span>, τιμή 1 αν ο μεταγλωττιστής συμμορφώνεται με το ISO standard της C, αλλιώς τιμή 0.
- <span class="p-style">\_\_STDC_VERSION__</span>, μια long ακέραια τιμή της μορφής <span class="p-style">yyyymmL</span>, όπου <span class="p-style">yyyy</span></span> και <span class="p-style">mm</span> είναι το έτος και ο μήνας της έκδοσης του standard που υποστηρίζεται. Για παράδειγμα η τιμή <span class="p-style">201710L</span> υποδηλώνει την αναθεώρηση του 2017 του C standard. Οι νεότερες εκδόσεις είναι πάντα μεγαλύτεροι αριθμοί σε σχέση με τις παλαιότερες, (π.χ. <span class="p-style">201710L > 201112L</span>).  

Ο κώδικας 12.10 περιέχει εντολές εκτύπωσης τιμών για τις παραπάνω προκαθορισμένες μακροεντολές.

```{.c title="Κώδικας 12.10: ch12_p7.c - εκτύπωση τιμών με προκαθορισμένες μακροεντολές." linenums="1"}
--8<-- "src/ch12_p7.c"
```

Η εκτέλεση του κώδικα εμφανίζει τα ακόλουθα αποτελέσματα.

```
$ gcc ch12_p7.c ‐o ch12_p7
$ ./ch12_p7
Macro __DATE__: Apr 20 2023
Macro __TIME__: 13:26:29
Macro __FILE__: ch12_p7.c
Macro __LINE__: 7
Macro __STDC__: 1
Macro __STDC_VERSION__: 201710
```

## 12.5 Οδηγίες υπό συνθήκη

Μια οδηγία υπό συνθήκη δίνει τη δυνατότητα επιλογής σχετικά με το εάν ένα τμήμα κώδικα θα παραμείνει ή όχι στον κώδικα που θα περάσει στον μεταγλωττιστή. Έτσι μπορεί να επιτευχθεί επιλεκτική συμπερίληψη κώδικα σύμφωνα με συνθήκες που οι τιμές τους υπολογίζονται κατά την προεπεξεργασία. Η οδηγία <span class="p-style">#if</span> ακολουθείται από μια παράσταση που εάν η τιμή της είναι μη μηδενική, θα συμπεριλάβει στον κώδικα όλες τις εντολές που ακολουθούν μέχρι το επόμενο <span class="p-style">#endif</span>, <span class="p-style">#elif</span> ή <span class="p-style">#else</span>. Μια συχνή χρήση των οδηγιών προεπεξεργαστή υπό συνθήκη είναι όταν ένας κώδικας πρέπει να διαφοροποιείται ανάλογα με το λειτουργικό σύστημα ή την αρχιτεκτονική του υπολογιστή που θα εκτελεστεί. Στο ακόλουθο παράδειγμα, στον κώδικα 12.11, πραγματοποιείται καθαρισμός της οθόνης με διαφορετική εντολή ανάλογα με το εάν πρόκειται για Windows ή για Linux/UNIX ή MacOS λειτουργικό σύστημα.

```{.c title="Κώδικας 12.11: ch12_p8.c - «εκκαθάριση» οθόνης και εμφάνιση του ονόματος του λειτουργικού συστήματος στο οποίο εκτελείται το πρόγραμμα." linenums="1"}
--8<-- "src/ch12_p8.c"
```

Αν για παράδειγμα ο παραπάνω κώδικας εκτελεστεί σε υπολογιστή με Windows, θα «καθαρίσει» την οθόνη και θα εμφανίσει το κείμενο Windows. Παρατηρήστε ότι στον κώδικα χρησιμοποιήθηκε δεξιά από το <span class="p-style">#if</span> το <span class="p-style">defined</span> που αν το λεκτικό σύμβολο που το ακολουθεί έχει οριστεί επιστρέφει την τιμή 1, αλλιώς επιστρέφει την τιμή 0.  

Μια άλλη χρήση των οδηγιών υπό συνθήκη είναι για να διαχωρίσουν κώδικα που χρησιμοποιείται για αποσφαλμάτωση, έτσι ώστε να ενεργοποιείται όταν ο προγραμματιστής επιλέξει ότι επιθυμεί την εμφάνιση πληροφοριών αποσφαλμάτωσης κατά την εκτέλεση του προγράμματος. Ο κώδικας 12.12 παρουσιάζει ένα σχετικό παράδειγμα.

```{.c title="Κώδικας 12.12: ch12_p9.c - επιλεκτική συμπερίληψη τμημάτων κώδικα για μεταγλώττιση." linenums="1"}
--8<-- "src/ch12_p9.c"
```

Η εκτέλεση του παραπάνω κώδικα θα εμφανίσει.

```
$ gcc ch12_p9.c ‐o ch12_p9
$ ./ch12_p9
DEBUG: x=1, y=1
bye
```

Αν όμως στη γραμμή 4 η εντολή γίνει <span class="p-style">#define DEBUG 0</span> τότε κατά την εκτέλεση θα εμφανιστεί μόνο το κείμενο bye. Επίσης, αν διαγραφεί η εντολή στη γραμμή 4, τότε το λεκτικό σύμβολο <span class="p-style">DEBUG</span> μπορεί να ορίζεται κατά τη μεταγλώττιση με τον διακόπτη ‐D όπως στη συνέχεια.

```
$ gcc ch12_p9.c ‐DDEBUG=1 ‐o ch12_p9
$ ./ch12_p9
DEBUG: x=1, y=1
bye
$ gcc ch12_p9.c ‐DDEBUG=0 ‐o ch12_p9
$ ./ch12_p9
bye
```

Ισοδύναμος κώδικας με το <span class="p-style">#if defined(FOO)</span> είναι ο <span class="p-style">#if defined FOO</span> και ο <span class="p-style">#ifdef FOO</span>. Επίσης, υπάρχει η δυνατότητα να χρησιμοποιηθεί το <span class="p-style">#ifndef FOO</span> που είναι ισοδύναμο με το <span class="p-style">#if !defined(FOO)</span> και σημαίνει ότι θα συμπεριληφθούν οι εντολές που ακολουθούν μέχρι το <span class="p-style">#endif</span> αν το λεκτικό σύμβολο <span class="p-style">FOO</span> δεν έχει οριστεί στον κώδικα που έχει προηγηθεί.

### 12.5.1 Φρουροί include 

Μια άλλη χρήση των οδηγιών υπό συνθήκη είναι στους λεγόμενους φρουρούς include (include guards). Συνήθως οι δηλώσεις ενός κώδικα απομονώνονται σε ένα αρχείο επικεφαλίδων με κατάληξη <span class="p-style">.h</span> (π.χ. <span class="p-style">utility.h</span>) και η υλοποίηση σε άλλο αρχείο με το ίδιο όνομα με κατάληξη <span class="p-style">.c</span> (π.χ. <span class="p-style">utility.c</span>). Το πρόγραμμα οδηγός (π.χ. <span class="p-style">main.c</span>) ή οποιοσδήποτε άλλος κώδικας απαιτεί γνώση των δηλώσεων που περιέχει το <span class="p-style">utility.h</span>, θα πρέπει να το κάνει <span class="p-style">include</span> (ή να κάνει <span class="p-style">include</span> ένα άλλο αρχείο που με τη σειρά του κάνει <span class="p-style">include</span> το <span class="p-style">utility.h</span>). Στο απλό παράδειγμα που ακολουθεί χρησιμοποιούνται 3 αρχεία, το <span class="p-style">ch12_p10_utility.h</span> (κώδικας 12.13), το <span class="p-style">ch12_p10_utility.c</span> (κώδικας 12.14) και το <span class="p-style">ch12_p10_main.c</span> (κώδικας 12.15). Στο πρώτο αρχείο δηλώνεται η συνάρτηση <span class="p-style">add_numbers</span>, στο δεύτερο αρχείο ορίζεται η συνάρτηση και στο τελευταίο η συνάρτηση καλείται από τη <span class="p-style">main()</span>.

```{.c title="Κώδικας 12.13: ch12_p10_utility.h - αρχείο επικεφαλίδας με δήλωση συνάρτησης και include guards." linenums="1"}
--8<-- "src/ch12_p10_utility.h"
```
Στο αρχείο επικεφαλίδας παρατηρείται το μοτίβο.

```
#ifndef CH12_P10_UTILITY_H
#define CH12_P10_UTILITY_H
...
#endif
```

Αυτό σημαίνει ότι την πρώτη και μόνο την πρώτη φορά που το αρχείο <span class="p-style">ch12_p10_utility.h</span> γίνεται include, ορίζεται το λεκτικό σύμβολο <span class="p-style">CH12_P10_UTILITY_H</span> και συμπεριλαμβάνονται στον κώδικα που θα μεταγλωττιστεί οι εντολές που ακολουθούν μέχρι το <span class="p-style">#endif</span>. Έτσι αποφεύγεται το πρόβλημα της διπλής δήλωσης συνάρτησης (αλλά και γενικότερα αναγνωριστικών), που θα συνέβαινε στην περίπτωση που το αρχείο επικεφαλίδων γινόταν <span class="p-style">include</span> πολλές φορές.

```{.c title="Κώδικας 12.14: ch12_p10_utility.c - αρχείο πηγαίου κώδικα με τον ορισμό της συνάρτησης add_numbers()." linenums="1"}
--8<-- "src/ch12_p10_utility.c"
```

```{.c title="Κώδικας 12.15: ch12_p10_main.c - αρχείο πηγαίου κώδικα που περιέχει τη main() και χρησιμοποιεί τη συνάρτηση add_numbers() που δηλώνεται στο αρχείο επικεφαλίδας ch2_p10_utility.h" linenums="1"}
--8<-- "src/ch12_p10_main.c"
```

Η μεταγλώττιση των δύο αρχείων πηγαίου κώδικα και η εκτέλεση του εκτελέσιμου που προκύπτει γίνεται όπως στη συνέχεια.

```
$ gcc ch12_p10_utility.c ch12_p10_main.c ‐o ch12_p10_main
$ ./ch12_p10_main
The result is 5
```

### 12.5.2 Κώδικας σε σχόλια με \#if 0

Για να τοποθετηθούν σε σχόλια πολλές συνεχόμενες γραμμές κώδικα στη C, χρησιμοποιείται ο συνδυασμός συμβόλων <span class="p-style">/\*</span> και <span class="p-style">\*/</span> που σηματοδοτούν την αρχή και το τέλος των γραμμών που θα αποτελέσουν σχόλια. Όμως, αυτός ο τρόπος δεν επιτρέπει εμφωλευμένα σχόλια, δηλαδή να τοποθετηθεί σε σχόλια ένας κώδικας που περιέχει ήδη σχόλια. Δηλαδή δεν επιτρέπεται κάτι όπως το ακόλουθο:

```
/*
...
        /*
        ...
        */
...
*/
```

Ωστόσο, μπορεί να χρησιμοποιηθεί η οδηγία υπό συνθήκη <span class="p-style">#if 0</span> έτσι ώστε να απενεργοποιηθεί ένα τμήμα κώδικα και να επιτευχθεί επί της ουσίας το επιθυμητό αποτέλεσμα του σχολιασμού κώδικα που περιέχει μέσα του σχόλια <span class="p-style">/\*</span> ... <span class="p-style">\*/</span>. Ένα σχετικό παράδειγμα παρουσιάζεται στον κώδικα 12.16.

```{.c title="Κώδικας 12.16: ch12_p11.c - χρήση της #if 0 για να οριστεί ένα εξωτερικό επίπεδο σχολίων μέσα στο οποίο μπορεί να υπάρχουν εμφωλευμένα σχόλια της μορφής /* ... */." linenums="1"}
--8<-- "src/ch12_p11.c"
```

Η εκτέλεση του προγράμματος δεν πρόκειται να εμφανίσει το μήνυμα <span class="p-style">Swap</span>, ούτε και να εκτελέσει τις εντολές από τη γραμμή 9 μέχρι και τη γραμμή 11 (1) που έτσι και αλλιώς βρίσκονται μέσα σε σχόλια. Αν στη γραμμή 6 αντικατασταθεί το 0 με 1, τότε πλέον κατά την εκτέλεση θα εμφανίζεται το μήνυμα <span class="p-style">Swap</span>, αλλά πάλι δεν θα εκτελούνται οι εντολές από τη γραμμή 9 μέχρι και γραμμή 11, καθώς θα βρίσκονται εντός σχολίων.
{ .annotate }

1. Οι εντολές αυτές πραγματοποιούν αντιμετάθεση των ακεραίων μεταβλητών a και b, με χρήση του τελεστή αποκλειστικής διάζευξης <span class="p-style">^</span> 


## 12.6 Άλλες οδηγίες

Πέρα από τις οδηγίες που αναφέρθηκαν υπάρχουν και άλλες οδηγίες όπως η <span class="p-style">#error</span>, η <span class="p-style">#pragma</span> και η <span class="p-style">#line</span>, ενώ υπάρχουν και άλλες οδηγίες που δεν ανήκουν στο standard της C και που υποστηρίζονται από συγκεκριμένους μεταγλωττιστές και μόνο.

### 12.6.1 Η οδηγία \#error

Η οδηγία <span class="p-style">#error</span> προκαλεί την εμφάνιση ενός λάθους και τον τερματισμό της μεταγλώττισης. Στον κώδικα 12.17 προκαλείται σφάλμα μεταγλώττισης σε περίπτωση που η μεταγλώττιση γίνεται σε λειτουργικό σύστημα που δεν είναι Linux/UNIX.

```{.c title="Κώδικας 12.17: ch12_p12.c - πρόκληση σφάλματος μεταγλώττισης αν το σύστημα στο οποίο γίνεται η μεταγλώττιση δεν είναι Linux/UNIX." linenums="1"}
--8<-- "src/ch12_p12.c"
```

Αν επιχειρηθεί μεταγλώττιση σε Windows υπολογιστή τότε εμφανίζεται το ακόλουθο σφάλμα μεταγλώττισης:

```
$ gcc ch12_p12.c ‐o ch12_p12
ch12_p12.c:3:2: error: #error "works only in linux!"
    3 | #error "works only in linux!"
      | ^~~~~
```
### 12.6.2 Η οδηγία \#pragma

Η οδηγία <span class="p-style">#pragma</span> συνήθως χρησιμοποιείται σύμφωνα με τις προδιαγραφές που ορίζουν εξωτερικές βιβλιοθήκες. Για παράδειγμα η βιβλιοθήκη OpenMP (1) ορίζει ότι ένας βρόχος επανάληψης θα εκτελεστεί παράλληλα με οδηγίες <span class="p-style">pragma</span> τοποθετημένες σε κατά τα άλλα συνηθισμένο κώδικα C. Ο κώδικας 12.18 που ακολουθεί ορίζει ότι ο βρόχος επανάληψης της εντολής <span class="p-style">for</span> θα εκτελεστεί από 2 νήματα (threads) παράλληλα, οπότε οι μισές επαναλήψεις θα γίνουν από το κάθε νήμα.
{ .annotate }

1. <a href="https://www.openmp.org/" target="_blank">https://www.openmp.org/</a>


```{.c title="Κώδικας 12.18: ch12_p13.c - κώδικας που χρησιμοποιεί 2 νήματα, με χρήση της βιβλιοθήκης OpenMP." linenums="1"}
--8<-- "src/ch12_p13.c"
```

Για να μπορεί να δημιουργηθεί το εκτελέσιμο πρόγραμμα για τον παραπάνω κώδικα θα πρέπει ο μεταγλωττιστής να υποστηρίζει το OpenMP και η μεταγλώττιση να γίνει χρησιμοποιώντας τον διακόπτη <span class="p-style">‐fopenmp</span>.

```
$ gcc ch12_p13.c ‐o ch12_p13 ‐fopenmp
$ ./ch12_p13
i = 0, thread 0
i = 1, thread 0
i = 2, thread 0
i = 3, thread 1
i = 4, thread 1
i = 5, thread 1
```

Μια κοινή χρήση της οδηγίας <span class="p-style">pragma</span> είναι το <span class="p-style">#pragma once</span> που δεν ανήκει μεν στο standard της C, αλλά υποστηρίζεται από τους πλέον διαδεδομένους μεταγλωττιστές της C (gcc, clang κ.ά.) και που μπορεί να χρησιμοποιηθεί ως εναλλακτική υλοποίηση για τους φρουρούς <span class="p-style">include</span> που αναφέρθηκαν στην παράγραφο 12.5.1. Έτσι αντί να υπάρχει στην αρχή και στο τέλος του κάθε αρχείου επικεφαλίδων όπως το <span class="p-style">hdr.h</span> το 

```
#ifndef HDR_H
#define HDR_H
...
#endif
```
αρκεί να υπάρχει στην αρχή του μόνο το <span class="p-style">#pragma once</span>.

### 12.6.3 Η οδηγία \#line

Η οδηγία <span class="p-style">#line</span> επιτρέπει την αλλαγή των τιμών που αναφέρει ο μεταγλωττιστής σχετικά με τον αριθμό γραμμής και το όνομα του αρχείου πηγαίου κώδικα που εκτελείται. Πρόκειται για τις τιμές που μπορούν να εμφανίζονται σε διαγνωστικά μηνύματα με τις μακροεντολές <span class="p-style">\_\_FILE__</span> και <span class="p-style">\_\_LINE__</span>. Στη συνέχεια παρατίθεται ένα παράδειγμα χρήσης της <span class="p-style">#line</span> στον κώδικα 12.19, όπου σε συγκεκριμένες θέσεις του κώδικα επαναορίζεται ο αριθμός γραμμής του κώδικα ή και το όνομα του αρχείου.


```{.c title="Κώδικας 12.19: ch12_p14.c - χρήση του #line για επανορισμό αριθμού γραμμών κώδικα και ονόματος αρχείου πηγαίου κώδικα κατά την εκτέλεση του προγράμματος." linenums="1"}
--8<-- "src/ch12_p14.c"
```

Η εκτέλεση του κώδικα θα δώσει τα ακόλουθα αποτελέσματα:

```
$ gcc ch12_p14.c ‐o ch12_p14
$ ./ch12_p14
Tracing file ch12_p14.c at line 4
Tracing file ch12_p14.c at line 100
Tracing file dummy.c at line 1
```

## 12.7 Είναι τελικά χρήσιμος ο προεπεξεργαστής της C;

O προεπεξεργαστής της C μπορεί να είναι η αιτία πρόκλησης προβλημάτων με τα οποία έρχονται αντιμέτωποι οι προγραμματιστές [^2]. Τέτοια προβλήματα είναι η πιθανότητα εισαγωγής σφαλμάτων στον κώδικα, η δημιουργία παραπλανητικού ή δυσνόητου κώδικα που μειώνει την αναγνωσιμότητά του και προκαλούνται σε μεγάλο βαθμό από την έλλειψη αντίληψης της σημασιολογίας της γλώσσας C από τον προεπεξεργαστή.
Ωστόσο, οι προγραμματιστές της C, εμπιστεύονται και χρησιμοποιούν τον προεπεξεργαστή καθώς επιτελεί αποτελεσματικά το έργο για το οποίο είναι υπεύθυνος. Για να αποφευχθούν προβλήματα συχνά ακολουθούνται κατευθυντήριες γραμμές (guidelines) στο πνεύμα των αρχών που έχει αποτυπώσει ο David Kieras στο “C Header File Guidelines” [^3].

## 12.8 Ασκήσεις

***Άσκηση 1*** Γράψτε μακροεντολή με όνομα <span class="p-style">SWAP</span> που να πραγματοποιεί αντιμετάθεση τιμών στα δύο ορίσματα που θα δέχεται. Εφαρμόστε τη μακροεντολή για αντιμετάθεση δύο ακεραίων τύπου <span class="p-style">int</span>.

??? note tip "Λύση άσκησης 1"
    ```{.c linenums="1"}
    --8<-- "src/ch12_e1.c"
    ```

***Άσκηση 2***  
Γράψτε μακροεντολή με όνομα <span class="p-style">FOREVER</span> που να υλοποιεί έναν άπειρο βρόχο. Καλέστε την μακροεντολή από κύριο πρόγραμμα.

??? tip "Λύση άσκησης 2"
    ```{.c linenums="1"}
    --8<-- "src/ch12_e2.c"
    ```

***Άσκηση 3***  
Γράψτε μακροεντολή με όνομα <span class="p-style">MALLOC</span> που να δέχεται 2 ορίσματα <span class="p-style">t</span> και <span class="p-style">n</span> και να δεσμεύει <span class="p-style">n</span> θέσεις τύπου <span class="p-style">t</span> και να επιστρέφει έναν δείκτη τύπου <span class="p-style">t</span> προς τις θέσεις μνήμης που δεσμεύτηκαν. Αν η δέσμευση μνήμης αποτυγχάνει να εμφανίζει μήνυμα σφάλματος.

??? tip "Λύση άσκησης 3"
    ```{.c linenums="1"}
    --8<-- "src/ch12_e3.c"
    ```

***Άσκηση 4***  
Γράψτε μια μακροεντολή με όνομα <span class="p-style">FOPEN</span> που να δέχεται 2 ορίσματα <span class="p-style">fn, m</span> και να ανοίγει ένα αρχείο με όνομα την τιμή του <span class="-style">fn</span> σε κατάσταση ανάγνωσης ή εγγραφής, σύμφωνα με την τιμή του <span class="p-style">m</span> (<span class="p-style">'r'</span> ή <span class="p-style">'w'</span>) και να πραγματοποιεί έλεγχο σφαλμάτων. Γράψτε πρόγραμμα που με τη χρήση της <span class="p-style">FOPEN</span> να διαβάζει να αρχείο κειμένου (π.χ. <span class="p-style">quotes.txt</span>) και να εμφανίζει τα περιεχόμενά του στη γραμμή εντολών.

??? tip "Λύση άσκησης 4"
    ```{.c linenums="1"}
    --8<-- "src/ch12_e4.c"
    ``` 

***Άσκηση 5***  
Γράψτε μια μακροεντολή με όνομα <span class="p-style">IS_GCC</span> που να μπορεί να χρησιμοποιηθεί για να εξεταστεί αν ο μεταγλωττιστής είναι ο GCC. Λάβετε υπόψη ότι ο GCC ορίζει το σύμβολο <span class="p-style">\_\_GNUC__</span>, αλλά το ίδιο σύμβολο ορίζεται και από τον μεταγλωττιστή clang που όμως ορίζει επιπλέον το σύμβολο <span class="p-style">\_\_clang__</span>.

??? tip "Λύση άσκησης 5"
    ```{.c linenums="1"}
    --8<-- "src/ch12_e5.c"
    ``` 

[^1]: Richard M Stallman και Zachary Weinberg. “The C preprocessor: For GCC version 14.0.0 (prerelease)”. Στο: <i>Free Software Foundation</i> (2023). [Online; accessed 2022-05-05], σ. 86.

[^2]: Flávio Medeiros, Christian Kästner, Márcio Ribeiro, Sarah Nadi και Rohit Gheyi. “The love/hate relationship with the C preprocessor: An interview study”. Στο: <i>29th European Conference on Object-Oriented Programming (ECOOP 2015)</i>. Schloss Dagstuhl-Leibniz-Zentrum fuer Informatik. 2015.

[^3]: David Kieras. <i>C Header File Guidelines.</i> <a href="https://websites.umich.edu/~eecs381/handouts/CHeaderFileGuidelines.pdf" target="_blank">https://websites.umich.edu/~eecs381/handouts/CHeaderFileGuidelines.pdf</a>. [Online; accessed 2022-05-05]. EECS Dept., University of Michigan, 2012.