#  11. Είσοδος/Έξοδος

<i>Σύνοψη</i> Ορίσματα γραμμής εντολών, η συνάρτηση <span class="p-style">getopt()</span>, αρχεία κειμένου και δυαδικά αρχεία, ο τύπος δεδομένων <span class="p-style">FILE</span>, ανάγνωση δεδομένων από αρχεία κειμένου με τις <span class="p-style">fgetc()</span>, <span class="p-style">fgets()</span>, <span class="p-style">fscanf()</span>, αποθήκευση δεδομένων σε αρχεία κειμένου με τις <span class="p-style">fputc()</span>, fprintf()</span>, ανάγνωση δεδομένων από δυαδικά αρχεία με την <span class="p-style">fread()</span>, εγγραφή δεδομένων σε δυαδικά αρχεία με την <span class="p-style">fwrite()</span>, μετακίνηση σε δυαδικά αρχεία με την <span class="p-style">fseek()</span>.  

<i>Προαπαιτούμενη γνώση</i> Τύποι δεδομένων, είσοδος/έξοδος, δομές επιλογής και επανάληψης, συναρτήσεις, πίνακες, δομές, δείκτες, αλφαριθμητικά.

## 11.1 Ορίσματα γραμμής εντολών

Η <span class="p-style">main()</span> είναι ειδικός τύπος συνάρτησης καθώς αποτελεί το σημείο εισόδου (entry point) για την εκτέλεση του προγράμματος. Ο προκαθορισμένος τύπος επιστροφής της είναι <span class="p-style">int</span> και υπάρχουν δύο τύποι της, ένας που δεν δέχεται παραμέτρους και ένας που δέχεται. Στα παραδείγματα κώδικα των προηγούμενων κεφαλαίων η <span class="p-style">main()</span> δεν δεχόταν παραμέτρους και για αυτόν το λόγο συμπεριλαμβανόταν στον κώδικα με τη μορφή:

```
int main(void) { ... }
```

Στη συνέχεια θα παρουσιαστούν παραδείγματα όπου η <span class="p-style">main()</span> θα δέχεται ορίσματα κατά την κλήση της, τα λεγόμενα ορίσματα γραμμής εντολών (command line arguments).

### 11.1.1 Παραδείγματα με ορίσματα γραμμής εντολών

Ένα παράδειγμα παρουσιάζεται στον κώδικα 11.1 όπου εντός των παρενθέσεων της <span class="p-style">main()</span> υπάρχουν δύο παράμετροι:

1. Στην πρώτη θέση μια ακέραια παράμετρος με όνομα argc που περιέχει το πλήθος των ορισμάτων που δίνονται από τη γραμμή εντολών κατά την κλήση του προγράμματος. Στο πλήθος αυτό προσμετράται πάντα και το όνομα του εκτελέσιμου προγράμματος.
2. Μια παράμετρος με όνομα argv που είναι ένας πίνακας αλφαριθμητικών. Τα στοιχεία του πίνακα είναι
τα ορίσματα της γραμμής εντολών συμπεριλαμβανομένου του ονόματος του εκτελέσιμου προγράμματος.

Τα ονόματα των παραμέτρων δεν είναι κατά ανάγκη argc και argv, αλλά έχει καθιερωθεί να χρησιμοποιούνται αυτά. Αν ο κώδικας 11.1 μεταγλωττιστεί και εκτελεστεί όπως στη συνέχεια, τα  αποτελέσματα θα είναι:

```{.c title="Κώδικας 11.1: ch11_p1.c - ένα απλό παράδειγμα εμφάνισης του πλήθους των ορισμάτων που δέχεται κατά την εκτέλεσή του ένα πρόγραμμα." linenums="1"}
--8<-- "src/ch11_p1.c"
```

```
$ gcc ch11_p1.c ‐o ch11_p1
$ ./ch11_p1
argc=1
```

Το πλήθος των ορισμάτων που εκτυπώνεται είναι 1, διότι όπως αναφέρθηκε προσμετράται και το ίδιο το εκτελέσιμο πρόγραμμα ως πρώτο. Αν στη συνέχεια εκτελέσουμε το ίδιο πρόγραμμα με περισσότερα ορίσματα
θα έχουμε την ακόλουθη έξοδο:

```
$ ./ch11_p1 alfa bravo charlie
argc=4
```

Σε αυτήν την περίπτωση τα ορίσματα είναι το όνομα του εκτελέσιμου και τα <span class="p-style">alfa</span>, <span class="p-style">bravo</span>, <span class="p-style">charlie</span> και συνεπώς το πλήθος είναι 4. Ένας νέος κώδικας που εκτυπώνει όλα τα ορίσματα είναι ο κώδικας 11.2 όπου κάθε όρισμα κατά την κλήση του εκτελέσιμου καταλαμβάνει και μια θέση στον πίνακα <span class="p-style">argv</span>.

```{.c title="Κώδικας 11.2: ch11_p2.c - εμφάνιση των ορισμάτων που δέχεται κατά την εκτέλεσή του το πρόγραμμα." linenums="1"}
--8<-- "src/ch11_p2.c"
```

Η μεταγλώττιση και εκτέλεση του προγράμματος θα δώσει τα ακόλουθα αποτελέσματα:

```
$ gcc ch11_p2.c ‐o ch11_p2
$ ./ch11_p2 alfa bravo charlie
argv[0]= ./ch11_p2
argv[1]= alpha
argv[2]= bravo
argv[3]= charlie
```

Στο επόμενο παράδειγμα, στον κώδικα 11.3, τα ορίσματα της γραμμής εντολών χρησιμοποιούνται για την εκτέλεση αριθμητικών πράξεων. Ο χρήστης εκτελεί το πρόγραμμα εισάγοντας την επιθυμητή πράξη π.χ. <span class="p-style">ADD</span> για πρόσθεση (<span class="p-style">SUB</span>, <span class="p-style">MUL</span>, <span class="p-style">DIV</span> για αφαίρεση, πολλαπλασιασμό και διαίρεση αντίστοιχα) και τους τελεστέους της πράξης. Ο κώδικας ελέγχει αρχικά ότι ο αριθμός των ορισμάτων είναι σωστός και αν δεν έχουν εισαχθεί τα 3 αναμενόμενα ορίσματα (πράξη, τελεστέος 1, τελεστέος 2) τότε εμφανίζεται μήνυμα που πληροφορεί για τον ορθό τρόπο εκτέλεσης του προγράμματος και η εκτέλεση τερματίζει. Αν από την άλλη μεριά έχει εισαχθεί το σωστό πλήθος ορισμάτων, τότε εκτελείται η πράξη και το αποτέλεσμα εμφανίζεται στην οθόνη. Για τη μετατροπή των ορισμάτων από αλφαριθμητικά σε πραγματικούς αριθμούς χρησιμοποιείται η συνάρτηση <span class="p-style">atof()</span> που ορίζεται στο <span class="p-style">stdlib.h</span>.


```{.c title="Κώδικας 11.3: ch11_p3.c - παράδειγμα με χρήση ορισμάτων για εκτέλεση αριθμητικών πράξεων." linenums="1"}
--8<-- "src/ch11_p3.c"
```

Ένα παράδειγμα μεταγλώττισης και εκτέλεσης του παραπάνω προγράμματος παρουσιάζεται στη συνέχεια:

```
$ gcc ch11_p3.c ‐o ch11_p3
$ ./ch11_p3 ADD 4.5 8.1
Result: 12.600000
```

### 11.1.2 Η συνάρτηση getopt()

Για διάφορες εντολές που μπορούν να δοθούν στη γραμμή εντολών υπάρχουν διακόπτες (switches) που τροποποιούν τη συμπεριφορά τους. Για παράδειγμα η εντολή <span class="p-style">tail</span> σε περιβάλλον UNIX μπορεί να κληθεί με τον διακόπτη <span class="p-style">‐n</span> όπως στη συνέχεια:

```
$ tail ‐n 3 file.txt
```

Το αποτέλεσμα της εντολής θα είναι η εκτύπωση των 3 τελευταίων γραμμών του αρχείου <span class="p-style">file.txt</span>. Αν η κλήση της <span class="p-style">tail</span> γινόταν χωρίς τον διακόπτη <span class="p-style">‐n</span> και την τιμή 3, τότε θα εμφάνιζε τις τελευταίες 10 γραμμές του αρχείου καθώς αυτή είναι η προκαθορισμένη συμπεριφορά που έχει οριστεί για το συγκεκριμένο μικρό πρόγραμμα. Συνεπώς, για την <span class="p-style">tail</span> ο διακόπτης <span class="p-style">‐n</span> καθορίζει το πλήθος των γραμμών που εμφανίζονται. Παρόμοια λειτουργικότητα μπορεί να επιτευχθεί και σε προγράμματα C με χρήση της συνάρτησης <span class="p-style">getopt(int argc, char \*\*argv, char \*options)</span> που ορίζεται στο <span class="p-style">unistd.h</span>. Οι παράμετροι που δέχεται η συνάρτηση <span class="p-style">getopt()</span> χρησιμοποιούνται ως εξής:

1. Η <span class="p-style">argc</span> είναι το πλήθος των ορισμάτων της γραμμής εντολών.
2. Η <span class="p-style">argv</span> είναι ο πίνακας των ορισμάτων της γραμμής εντολών.
3. Η <span class="p-style">options</span> χρησιμοποιείται για να ορίσει ποια ορίσματα της γραμμής εντολών είναι διακόπτες και ποια απαιτούν επιπλέον και τιμή.  

Ένα παράδειγμα χρήσης της συνάρτησης <span class="p-style">getopt()</span> παρουσιάζεται στον κώδικα 11.4, με σχόλια που εξηγούν τον ρόλο της μεταβλητής <span class="p-style">options</span>, της συνάρτησης <span class="p-style">getopt()</span> και της μεταβλητής optarg που ορίζεται στο <span class="p-style">unistd.h</span>.

```{.c title="Κώδικας 11.4: ch11_p4.c - κώδικας που χρησιμοποιεί τη συνάρτηση getopt()." linenums="1"}
--8<-- "src/ch11_p4.c"
```

Η συνάρτηση <span class="p-style">getopt()</span> πρέπει να καλείται επαναληπτικά μέχρι να επιστρέψει -1. Σε κάθε επανάληψη επιστρέφει το επόμενο όρισμα στη σειρά των ορισμάτων. Τα αποδεκτά ορίσματα περιγράφονται στη μεταβλητή <span class="p-style">options</span>. Αν μετά το όνομα του ορίσματος ακολουθεί το σύμβολο <span class="p-style">:</span>, τότε το όρισμα αυτό πρέπει να ακολουθείται από κάποια τιμή. Η λήψη αυτής της τιμής γίνεται μέσω της μεταβλητής <span class="p-style">optarg</span>. Στην περίπτωση του κώδικα 11.4 επιτρέπονται τα ακόλουθα τρία ορίσματα:

1. Το όρισμα <span class="p-style">‐a</span>, που είναι ένας απλός διακόπτης και συνεπώς δεν ακολουθείται από κάποια τιμή. Αν η εκτέλεση του προγράμματος  συμπεριλάβει το όρισμα αυτό, η μεταβλητή <span class="p-style">aflag</span> θα λάβει την τιμή 1, αλλιώς θα λάβει την τιμή 0.
2. Το όρισμα <span class="p-style">‐b</span>, που δέχεται αμέσως μετά μια ακέραια τιμή. Αυτή η τιμή ανατίθεται στην τοπική μεταβλητή <span class="p-style">bvalue</span>.
3. Το όρισμα <span class="p-style">‐d</span>, που δέχεται μια δεκαδική τιμή μετά από αυτό. Αυτή η δεκαδική τιμή θα ανατεθεί στην τοπική μεταβλητή <span class="p-style">dvalue</span>.

<div style="text-align: center;"><b>Πίνακας 11.1:</b><i> Τιμές κατάστασης ανοίγματος αρχείων.</i></div>

| Κατάσταση (mode) | Σημασία |
|------------------|-----------------------------------------------------------------------------------|
| "r"              |Ανοίγει το αρχείο μόνο για ανάγνωση. Αν το αρχείο δεν υπάρχει, επιστρέφεται σφάλμα.|
| "w"              |Ανοίγει το αρχείο για εγγραφή. Αν το αρχείο υπάρχει, τα περιεχόμενά του διαγράφονται και αν δεν υπάρχει, δημιουργείται ένα νέο αρχείο.|
| "a"              |Ανοίγει το αρχείο για προσάρτηση (append). Αν το αρχείο υπάρχει, η εγγραφή γίνεται στο τέλος του αρχείου. Αν δεν υπάρχει, δημιουργείται ένα νέο.|
| "r+"             |Ανοίγει το αρχείο για ανάγνωση και εγγραφή. Δεν δημιουργεί νέο αρχείο αν αυτό δεν υπάρχει.|
| "w+"             |Παρόμοιο με το "w", αλλά επιτρέπει και την ανάγνωση του αρχείου. Εάν το αρχείο υπάρχει, τα περιεχόμενά του διαγράφονται.|
|  "a+"            |Παρόμοιο με το "a", αλλά επιτρέπει και την ανάγνωση του αρχείου. Η εγγραφή γίνεται στο τέλος του αρχείου. Δηλαδή, ανεξάρτητα από την τρέχουσα θέση του δείκτη στο αρχείο κατά την ανάγνωση, η εγγραφή προσθέτει πάντα τα δεδομένα στο τέλος του αρχείου.|


Ένα παράδειγμα εκτέλεσης παρουσιάζεται στη συνέχεια:

```
$ gcc ch11_p4.c ‐o ch11_p4
$ ./ch11_p4 ‐a ‐b 42 ‐d 3.14
Command line arguments: a=1 b=42 d=3.140000
```

## 11.2 Ο τύπος δεδομένων FILE

Υπάρχουν δύο κατηγορίες αρχείων, τα αρχεία κειμένου και τα δυαδικά αρχεία. Τα αρχεία κειμένου περιέχουν δεδομένα που μπορούν να διαβαστούν από οποιονδήποτε κειμενογράφο απλού κειμένου. Σε αυτήν την κατηγορία ανήκουν για παράδειγμα τα αρχεία κώδικα. Στη δεύτερη κατηγορία είναι αρχεία που απαιτούν ειδική εφαρμογή έτσι ώστε να διαβαστούν τα περιεχόμενά τους. Τέτοια αρχεία είναι για παράδειγμα τα αρχεία .docx από το Microsoft Word, τα αρχεία <span class="p-style">.xlsx</span> από το Microsoft Excel, τα αρχεία εικόνας <span class="p-style">.png</span> κ.λπ.  
Στη γλώσσα C τα αρχεία ανοίγουν με τη συνάρτηση <span class="p-style">fopen(filepath, mode)</span>. Το πρώτο όρισμα είναι το όνομα του αρχείου που πρέπει να ανοίξει (συμπληρωμένο με τη διαδρομή του στο σύστημα αρχείων, αν το αρχείο δεν βρίσκεται στον ίδιο κατάλογο με το αρχείο του κώδικα). Το δεύτερο όρισμα ορίζει την κατάσταση (mode) στην οποία θα ανοίξει το αρχείο με αποδεκτές τιμές αυτές που παρουσιάζονται στον Πίνακα 11.1. Η συνάρτηση <span class="p-style">fopen()</span> επιστρέφει <span class="p-style">NULL</span> αν δεν μπορεί να ανοίξει το συγκεκριμένο αρχείο με το συγκεκριμένο mode. Αν τα καταφέρει  επιστρέφει έναν δείκτη προς μια ειδική δομή <span class="p-style">FILE</span>.              
Το παράδειγμα του κώδικα 11.5 επιχειρεί να ανοίξει το αρχείο <span class="p-style">test.txt</span> για ανάγνωση υποθέτοντας ότι βρίσκεται στον ίδιο τοπικό φάκελο. Αν το αρχείο ανοίξει επιτυχώς, τότε εμφανίζεται ένα μήνυμα που πληροφορεί για την επιτυχία ανοίγματος του αρχείου αλλιώς εμφανίζεται μήνυμα λάθους.

```{.c title="Κώδικας 11.5: ch11_p5.c - άνοιγμα αρχείου κειμένου." linenums="1"}
--8<-- "src/ch11_p5.c"
```

## 11.3 Είσοδος από αρχεία κειμένου

### 11.3.1 Ανάγνωση χωρίς διαμόρφωση

Για την ανάγνωση αρχείων απλού κειμένου υπάρχουν δύο τρόποι: ο πρώτος είναι να γίνει ανάγνωση του αρχείου χαρακτήρα προς χαρακτήρα, ενώ ο δεύτερος είναι να γίνει ανάγνωση ανά γραμμή. Ο πρώτος τρόπος παρουσιάζεται στον κώδικα 11.6, όπου γίνεται ανάγνωση όλων των χαρακτήρων που βρίσκονται σε ένα αρχείο και εμφανίζεται ο συνολικός αριθμός τους καθώς και ο συνολικός αριθμός γραμμών. Για την ανάγνωση
κάθε χαρακτήρα χρησιμοποιείται η συνάρτηση <span class="p-style">fgetc()</span> που κάθε κλήση της επιστρέφει τον επόμενο χαρακτήρα από το αρχείο εισόδου και αν δεν υπάρχουν άλλοι χαρακτήρες, επιστρέφει τη σταθερά <span class="p-style">EOF</span> (End Of File).

```{.c title="Κώδικας 11.6: ch11_p6.c - ανάγνωση χαρακτήρα προς χαρακτήρα των περιεχομένων ενός αρχείου κειμένου." linenums="1"}
--8<-- "src/ch11_p6.c"
```

Ο τρόπος ανάγνωσης αρχείου του κώδικα 11.6 είναι σχετικά αργός καθώς πρέπει να κάνει τόσες αναγνώσεις από το αρχείο όσοι είναι και οι χαρακτήρες του αρχείου. Εναλλακτικά, μπορεί να γίνει ανάγνωση γραμμή προς γραμμή με τη συνάρτηση <span class="p-style">fgets()</span> όπως παρουσιάζεται στον κώδικα 11.7.

```{.c title="Κώδικας 11.7: ch11_p7.c - ανάγνωση γραμμή προς γραμμή των περιεχομένων ενός αρχείου κειμένου." linenums="1"}
--8<-- "src/ch11_p7.c"
```

Η συνάρτηση <span class="p-style">fgets()</span> δέχεται τρία ορίσματα:  

1. Έναν δείκτη προς το αλφαριθμητικό στο οποίο θα γίνει αποθήκευση της εισόδου.
2. Τον μέγιστο αριθμό χαρακτήρων που θα διαβαστούν από το αρχείο. Αν η ανάγνωση φτάσει στο τέλος της γραμμής και το πλήθος των γραμμάτων είναι μικρότερο από τον μέγιστο αριθμό, τότε η <span class="p-style">fgets()</span> τερματίζει και επιστρέφει τη γραμμή που διάβασε, διαφορετικά διαβάζει τόσους χαρακτήρες όσος είναι ο μέγιστος αριθμός χαρακτήρων.
3. Ένα δείκτη προς το αρχείο από το οποίο γίνεται η ανάγνωση.

Επίσης, η συνάρτηση <span class="p-style">fgets()</span> επιστρέφει έναν δείκτη προς τη γραμμή που διάβασε από το αρχείο. Αν τα δεδομένα του αρχείου τελειώσουν, τότε η συνάρτηση επιστρέφει <span class="p-style">NULL</span>.  
Έστω ένα αρχείο <span class="p-style">test.txt</span>, στον ίδιο κατάλογο με τον κώδικα, με το ακόλουθο περιεχόμενο:

```
Excerpt from the Tao of programming (https://www.mit.edu/~xela/tao.html)
If the Tao is great, then the operating system is great.
If the operating system is great, then the compiler is great.
If the compiler is great, then the application is great.
The user is pleased , and there is harmony in the world.
```

Η εκτέλεση του κώδικα 11.6, όπως και του κώδικα 11.7 για το συγκεκριμένο αρχείο (test.txt) εμφανίζει τα ακόλουθα αποτελέσματα:

```
Excerpt from the Tao of programming (https://www.mit.edu/~xela/tao.html)
If the Tao is great, then the operating system is great.
If the operating system is great, then the compiler is great.
If the compiler is great, then the application is great.
The user is pleased , and there is harmony in the world.
Characters: 304
Lines: 5
```

Αξίζει να σημειωθεί ότι η <span class="p-style">fgets()</span> διαβάζοντας το αρχείο κειμένου αντιγράφει στο αλφαριθμητικό και την αλλαγή γραμμής. Οι γραμμές 16-21 στον κώδικα 11.7 αντικαθιστούν τον τελευταίο χαρακτήρα, αν είναι αλλαγή γραμμής, με τον χαρακτήρα τερματισμού αλφαριθμητικών.


### 11.3.2 Ανάγνωση με διαμόρφωση

Αν τα δεδομένα που πρέπει να διαβαστούν δεν είναι κείμενο, αλλά είναι για παράδειγμα αριθμοί, τότε η ανάγνωση των τιμών από το αρχείο μπορεί να γίνει με τη χρήση της <span class="p-style">fscanf()</span>. Στο παράδειγμα του κώδικα 11.8, έστω ότι στο αρχείο <span class="p-style">grades.txt</span> υπάρχουν σε κάθε γραμμή του τρεις αριθμοί, ένας ακέραιος που είναι ο αριθμός μητρώου φοιτητή και δύο δεκαδικοί που είναι η βαθμολογία του φοιτητή σε διάλεξη και εργαστήριο αντίστοιχα. Το πρόγραμμα εμφανίζει τον αριθμό μητρώου του φοιτητή με τη μεγαλύτερη μέση βαθμολογία. Ο κώδικας θεωρεί ότι το πλήθος των φοιτητών είναι γνωστό και ίσο με 5.

```{.c title="Κώδικας 11.8: ch11_p8.c - ανάγνωση διαμορφωμένου αρχείου κειμένου με 5 εγγραφές." linenums="1"}
--8<-- "src/ch11_p8.c"
```

Αν θεωρηθεί ότι τα περιεχόμενα του αρχείου εισόδου (<span class="p-style">grades.txt</span>) είναι τα ακόλουθα:

```
100 10 5
101 8 7
102 9 6
103 7 5
104 8 8
```

τότε το αποτέλεσμα εκτέλεσης του κώδικα 11.8 θα είναι:

```
The student with the best performance is: 104
The best performance is                 : 8.000000
```

Ωστόσο, συνήθως το πλήθος των εγγραφών σε ένα αρχείο δεν είναι γνωστό και επομένως θα πρέπει να χρησιμοποιηθεί διαφορετικός τρόπος για την ανάγνωση όλων των στοιχείων αρχείου δεδομένων. Για να επιτευχθεί αυτό μπορεί να χρησιμοποιηθεί η τιμή επιστροφής της συνάρτησης <span class="p-style">fscanf()</span> καθώς επιστρέφει το πλήθος των ορισμάτων που μπόρεσε να διαβάσει με επιτυχία. Για παράδειγμα η ανάθεση:

```
int n = fscanf(fp,"%d %d",&x,&y);
```

θα επιστρέψει στη μεταβλητή n την τιμή 2 αν μπόρεσε να διαβάσει με επιτυχία δύο αριθμούς. Αν δεν υπάρχουν όμως άλλοι αριθμοί να διαβάσει, τότε η συνάρτηση θα επιστρέψει την τιμή 0. Το χαρακτηριστικό αυτό χρησιμοποιείται στον κώδικα 11.9, προκειμένου να εντοπιστεί και πάλι η καλύτερη βαθμολογία φοιτητή.

```{.c title="Κώδικας 11.9: ch11_p9.c - ανάγνωση διαμορφωμένου αρχείου κειμένου με άγνωστο πλήθος εγγραφών." linenums="1"}
--8<-- "src/ch11_p9.c"
```

Πολλές φορές τα αρχεία δεδομένων ενδέχεται να χρησιμοποιούν διαχωριστές για τα δεδομένα. Επίσης, εφαρμογές όπως το Microsoft Excel ή το Libreoffice Calc εξάγουν τα δεδομένα σε μορφή CSV (Comma Separated Values), δηλαδή κάθε στήλη χωρίζεται από την επόμενη με κάποιον διαχωριστή όπως είναι το κόμμα. Έτσι το προηγούμενο αρχείο βαθμολογίας θα μπορούσε να έχει την εξής διαμόρφωση:

```
100,10,5
101,8,7
102,9,6
103,7,5
104,8,8
```

Για να μπορέσει η εφαρμογή να διαβάσει αρχεία αυτής της μορφής, θα πρέπει να γίνει ανάγνωση καθεμιάς γραμμής του αρχείου ξεχωριστά και στη συνέχεια να διαχωριστεί η γραμμή στα επιμέρους στοιχεία της, δηλαδή κωδικό σπουδαστή και βαθμολογίες. Ο κώδικας 11.10 πραγματοποιεί ακριβώς αυτό, ενώ για τον διαχωρισμό των στοιχείων της κάθε γραμμής χρησιμοποιείται η συνάρτηση <span class="p-style">strtok()</span>.

```{.c title="Κώδικας 11.10: ch11_p10.c - ανάγνωση δεδομένων από αρχείο csv." linenums="1"}
--8<-- "src/ch11_p10.c"
```

## 11.4 Έξοδος σε αρχεία κειμένου

Για την εγγραφή χαρακτήρων σε αρχεία κειμένου μπορεί να χρησιμοποιηθεί η συνάρτηση <span class="p-style">fputc()</span>. Η συνάρτηση αυτή δέχεται ως πρώτο όρισμα τον χαρακτήρα που θα γραφεί στο αρχείο και ως δεύτερο όρισμα έναν δείκτη προς το αρχείο που θα γίνει η εγγραφή. Στο παράδειγμα του κώδικα 11.11, παρουσιάζεται η εγγραφή τυχαίων γραμμάτων του αγγλικού αλφαβήτου σε ένα αρχείο κειμένου. Ο χρήστης εισάγει το επιθυμητό όνομα αρχείου και το πλήθος των τυχαίων γραμμάτων και παράγονται αντίστοιχα κεφαλαία γράμματα που γράφονται σε αυτό το αρχείο.

```{.c title="Κώδικας 11.11: ch11_p11.c - εγγραφή αποτελεσμάτων σε αρχείο κειμένου." linenums="1"}
--8<-- "src/ch11_p11.c"
```

Ένα παράδειγμα εκτέλεσης παρουσιάζεται στη συνέχεια:

```
Input the name of the file: a.txt
Input a number of characters: 10
LRFKQYUQFJ
```

Για την εγγραφή άλλων τιμών πέρα από χαρακτήρες σε αρχεία μπορεί να χρησιμοποιηθεί η συνάρτηση <span class="p-style">fprintf()</span> που έχει παρόμοια σύνταξη με τη συνάρτηση <span class="p-style">printf()</span> αλλά με τη διαφορά πως η έξοδος γίνεται σε αρχείο, αντί για την οθόνη. Στο παράδειγμα του κώδικα 11.12 αποθηκεύονται στο αρχείο fibonacci.txt οι 10 πρώτοι όροι της ακολουθίας Fibonacci (1).
{ .annotate }

1. <a href="https://r-knott.surrey.ac.uk/Fibonacci/fib.html" target="_blank">https://r-knott.surrey.ac.uk/Fibonacci/fib.html</a>

```{.c title="Κώδικας 11.12: ch11_p12.c - αποθήκευση των 10 πρώτων όρων της ακολουθίας Fibonacci σε αρχείο κειμένου." linenums="1"}
--8<-- "src/ch11_p12.c"
```

Μετά την εκτέλεση του προγράμματος θα έχει δημιουργηθεί το αρχείο fibonacci.txt στον ίδιο κατάλογο με το εκτελέσιμο πρόγραμμα και θα έχει τα ακόλουθα περιεχόμενα: 

```
 1   1
 2   1
 3   2
 4   3
 5   5
 6   8
 7  13
 8  21
 9  34
10  55
```

Τα πεδία δομών μπορούν επίσης να εγγραφούν σε αρχεία κειμένου. Για παράδειγμα ο κώδικας 11.13, αποθηκεύει δύο εγγραφές της δομής <span class="p-style">student</span> στο αρχείο <span class="p-style">students.txt</span>.

```{.c title="Κώδικας 11.13: ch11_p13.c - αποθήκευση περιεχομένου δομών σε αρχείο κειμένου." linenums="1"}
--8<-- "src/ch11_p13.c"
```

Στο αρχείο students.txt η πληροφορία εγγράφεται με την ακόλουθη μορφή:

```
John Doe 100 5
Jane Doe 101 5
```

## 11.5 Δυαδικά αρχεία

Τα αρχεία κειμένου, αν και είναι εύκολα στον χειρισμό τους και άμεσα αναγνώσιμα, αποτελούν τη συντριπτική μειοψηφία των αρχείων που υπάρχουν σε έναν ηλεκτρονικό υπολογιστή. Για παράδειγμα τα αρχεία ήχου, τα αρχεία εικόνας, τα φύλλα εργασίας, οι παρουσιάσεις κ.λπ. δεν είναι αρχεία κειμένου αλλά ειδικού τύπου αρχεία που συχνά αποκαλούνται δυαδικά αρχεία (binary files). Αρχεία τέτοιου είδους απαιτούν ειδικές εφαρμογές για τον χειρισμό τους, αλλά η πρόσβαση στα δεδομένα τους είναι πολύ πιο γρήγορη από ότι σε αρχεία κειμένου. Αυτό συμβαίνει διότι τα δεδομένα γράφονται και διαβάζονται στο αρχείο απευθείας ως bytes και όχι με διαμόρφωση κειμένου. Στη C συνήθως τα δυαδικά αρχεία χρησιμοποιούνται για εγγραφή και ανάγνωση δομών (structs).

### 11.5.1 Έξοδος σε δυαδικό αρχείο

Η εγγραφή δεδομένων σε δυαδικά αρχεία δεν γίνεται με τη συνάρτηση <span class="p-style">fprint()</span>, καθώς αυτή γράφει μορφοποιημένο κείμενο και όχι απευθείας bytes. Η εγγραφή δυαδικών δεδομένων γίνεται με τη χρήση της συνάρτησης <span class="p-style">fwrite(x, size, count, fp)</span> με τα ορίσματά της να έχουν την ακόλουθη σημασία:  

1. <span class="p-style">x</span> είναι ένας δείκτης προς τα δεδομένα που πρόκειται να εγγραφούν στο αρχείο. Συνήθως πρόκειται για έναν δείκτη προς μια δομή ή για έναν πίνακα δομών.
2. <span class="p-style">size</span> είναι το μέγεθος σε bytes καθεμίας εγγραφής που θα αποθηκευτεί στο αρχείο.
3. <span class="p-style">count</span> είναι το πλήθος των εγγραφών που θα αποθηκευτούν στο αρχείο.
4. <span class="p-style">fp</span> είναι δείκτης προς το αρχείο.  


Στο παράδειγμα του κώδικα 11.14 παρουσιάζεται η αποθήκευση δυο εγγραφών της δομής <span class="p-style">person</span> στο αρχείο <span class="p-style">persons.txt</span>.

```{.c title="Κώδικας 11.14: ch11_p14.c - αποθήκευση εγγραφών της δομής student σε δυαδικό αρχείο." linenums="1"}
--8<-- "src/ch11_p14.c"
```

Η εμφάνιση των περιεχομένων του αρχείου <span class="p-style">persons.bin</span> δεν είναι εφικτή με έναν απλό επεξεργαστή κειμένου (αν και οι χαρακτήρες στα δεδομένα μπορεί να είναι ορατοί). Ωστόσο, αν χρησιμοποιηθεί μια εντολή όπως η <span class="p-style">xxd</span> (1) ενός UNIX συστήματος θα ληφθούν αποτελέσματα παρόμοια με τα ακόλουθα:
{ .annotate }

1. <a href="https://linuxhandbook.com/xxd-command/" target="_blank">https://linuxhandbook.com/xxd-command/</a>

```
$ xxd persons.bin
00000000: 4a6f 686e 0000 0000 0000 0000 0000 0000 John............
00000010: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000020: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000060: 0000 0000 446f 6500 0000 0000 0000 0000 ....Doe.........
00000070: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000 ................
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000 ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000 ................
000000c0: 0000 0000 0000 0000 2e00 0000 5269 6368 ............Rich
000000d0: 6172 6400 0000 0000 0000 0000 0000 0000 ard.............
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000 ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000100: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000110: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000120: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000130: 526f 6500 0000 0000 0000 0000 0000 0000 Roe.............
00000140: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000150: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000160: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000170: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000180: 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000190: 0000 0000 2100 0000                     ....!...
```

Ο κώδικας 11.14 γράφει στο αρχείο <span class="p-style">persons.bin</span> με δύο εντολές <span class="p-style">fwrite</span>, αλλά αυτό θα μπορούσε να συμβεί και με μόνο μία εντολή για μεγαλύτερη ταχύτητα, όπως φαίνεται στον κώδικα 11.15.  

```{.c title="Κώδικας 11.15: ch11_p15.c - αποθήκευση 2 εγγραφών της δομής person σε δυαδικό αρχείο με την fwrite()." linenums="1"}
--8<-- "src/ch11_p15.c"
```

### 11.5.2 Είσοδος από δυαδικό αρχείο

Η συνάρτηση <span class="p-style">fread()</span> μπορεί να χρησιμοποιηθεί για ανάγνωση δεδομένων από δυαδικά αρχεία και η σύνταξή της είναι παρόμοια με τη σύνταξη της <span class="p-style">fwrite()</span>. Στο παράδειγμα του κώδικα 11.16 γίνεται ανάγνωση των δύο εγγραφών της δομής <span class="p-style">person</span> που αποθηκεύτηκαν στο αρχείο <span class="p-style">persons.bin</span> με τον κώδικα 11.15.

```{.c title="Κώδικας 11.16: ch11_p16.c - ανάγνωση εγγραφών της δομής person από δυαδικό αρχείο με την fread()." linenums="1"}
--8<-- "src/ch11_p16.c"
```

### 11.5.3 Μετακίνηση με την fseek()

Μια ευκολία που παρέχουν τα δυαδικά αρχεία είναι η δυνατότητα μετακίνησης σε οποιοδήποτε σημείο τους.  
Για να γίνει αυτό χρησιμοποιείται η συνάρτηση:

```
int fseek(fp, offset, whence);
```
όπου οι παράμετροί της έχουν την ακόλουθη σημασία:

1. <span class="p-style">fp</span> είναι ο δείκτης προς το αρχείο.
2. <span class="p-style">offset</span> είναι ο αριθμός των bytes σε σχέση με το <span class="p-style">whence</span>.
3. <span class="p-style">whence</span> μπορεί να λάβει τρεις συμβολικές τιμές: 

    1. <span class="p-style">SEEK_SET</span>, συμβολίζει την αρχή του αρχείου.
    2. <span class="p-style">SEEK_CUR</span>, συμβολίζει την τρέχουσα θέση στο αρχείο.
    3. <span class="p-style">SEEK_END</span>, συμβολίζει το τέλος του αρχείου  

Μια συνηθισμένη χρήση της <span class="p-style">fseek()</span> είναι για τον υπολογισμό του συνολικού μεγέθους ενός αρχείου σε bytes. Αυτό μπορεί να γίνει σε συνδυασμό με τη συνάρτηση <span class="p-style">ftell()</span>, που επιστρέφει την τρέχουσα θέση σε bytes σε ένα αρχείο. Ένα παράδειγμα υπολογισμού του μεγέθους ενός αρχείου παρουσιάζεται στον κώδικα 11.17 όπου γίνεται μετακίνηση στο τέλος του αρχείου και στη συνέχεια υπολογίζεται το συνολικό μέγεθος σε bytes με χρήση της <span class="p-style">ftell()</span>.

```{.c title="Κώδικας 11.17: ch11_p17.c - υπολογισμός του μεγέθους ενός αρχείου σε bytes με τις fseek() και ftell()." linenums="1"}
--8<-- "src/ch11_p17.c"
```

Θεωρώντας ότι το αρχείο persons.bin που δημιουργήθηκε με τον κώδικα 11.15 υπάρχει, η εκτέλεση του παραπάνω προγράμματος θα εμφανίσει:

```
Size of persons.bin = 408 bytes
```

Ένα ακόμα παράδειγμα χρήσης της <span class="p-style">fseek()</span> παρουσιάζεται στον κώδικα 11.18. Ο κώδικας ανοίγει το δυαδικό αρχείο εγγραφών <span class="p-style">persons.bin</span>, μετακινείται στην τελευταία εγγραφή, διαβάζει τα περιεχόμενά της και τα εμφανίζει.

```{.c title="Κώδικας 11.18: ch11_p18.c - μετακίνηση στην τελευταία εγγραφή ενός δυαδικού αρχείου και εμφάνισή της." linenums="1"}
--8<-- "src/ch11_p18.c"
```

Η εκτέλεση του προγράμματος, εφόσον υπάρχει το αρχείο <span class="p-style">persons.bin</span> θα εμφανίσει:

```
Person details: Richard Roe 33
```

## 11.6 Ασκήσεις

***Άσκηση 1***  
Να γραφεί πρόγραμμα που ο χρήστης να εισάγει το όνομα ενός αρχείου κειμένου και το πρόγραμμα να εμφανίζει το ποσοστό των χαρακτήρων του αρχείου που είναι κεφαλαία γράμματα του αγγλικού αλφαβήτου.

??? tip "Λύση άσκησης 1"
    ```{.c linenums="1"}
    --8<-- "src/ch11_e1.c"
    ```

***Άσκηση 2***  
Nα γραφεί πρόγραμμα που ο χρήστης να εισάγει το όνομα ενός αρχείου κειμένου και το πρόγραμμα να εμφανίζει τις γραμμές του αρχείου που ξεκινούν με κεφαλαίο γράμμα του αγγλικού αλφαβήτου.  

??? tip "Λύση άσκησης 2"
    ```{.c linenums="1"}
    --8<-- "src/ch11_e2.c"
    ```

***Άσκηση 3***  
Nα γραφεί πρόγραμμα που ο χρήστης να εισάγει ακέραιους αριθμούς επαναληπτικά μέχρι να δώσει την τιμή 0. Για κάθε αριθμό που εισάγει ο χρήστης, αν είναι πρώτος, να εισάγεται στο αρχείο <span class="p-style">primes.txt</span> και να εμφανίζεται σχετικό μήνυμα. Το πρόγραμμα πριν τον τερματισμό του να εμφανίζει τα περιεχόμενα του <span class="p-style">primes.txt</span>.  

??? tip "Λύση άσκησης 3"
    ```{.c linenums="1"}
    --8<-- "src/ch11_e3.c"
    ```

***Άσκηση 4***  
Γράψτε ένα πρόγραμμα που θα εγγράφει μια ακολουθία ακεραίων τιμών σε ένα αρχείο κειμένου με τις τιμές μεταξύ τους διαχωρισμένες με κόμματα. Οι τιμές να επιλέγονται τυχαία στο διάστημα [0,100) και το πλήθος τους να καθορίζεται από τον χρήστη κατά την εκτέλεση του προγράμματος. Στη συνέχεια να διαβάζει τις τιμές από το αρχείο και να υπολογίζει και να εμφανίζει τον μέσο όρο τους. Να υπολογίζει και να εμφανίζει τους χρόνους που χρειάστηκε για να γίνει τόσο η εγγραφή των ακεραίων τιμών στο αρχείο, όσο και η ανάγνωση των τιμών. Επαναλάβετε τη διαδικασία, αλλά αυτήν τη φορά για εγγραφή και ανάγνωση των ακεραίων τιμών σε δυαδικό αρχείο. Συγκρίνετε τους χρόνους.  
  
*Παρατήρηση*: Η μέτρηση χρόνου εκτέλεσης από τη γραμμή εντολών μπορεί να γίνει με το βοηθητικό πρόγραμμα time σε Linux και MacOS. Στα Windows μπορεί να εγκατασταθεί το ptime <a href="https://www.pc-tools.net/win32/ptime/" target="_blank">https://www.pc-tools.net/win32/ptime/</a> για να προσομοιωθεί παρόμοια λειτουργικότητα με το time του Linux.  

??? tip "Λύση άσκησης 4"
    ```{.c linenums="1"}
    --8<-- "src/ch11_e4.c"
    ```